<!doctype html>
<html>
  <head>
    <title>Narcos</title>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
    />
    <style>
      body,
      html {
        position: fixed;
      }
    </style>
  </head>
  <script type="text/javascript">
    ;(function () {
      // --- 1. Get Tokens From URL ---
      const params = new URLSearchParams(window.location.search)
      var accessToken = params.get('token')
      var refreshToken = params.get('refresh_token')
      localStorage.setItem('access_token', accessToken)
      localStorage.setItem('refresh_token', refreshToken)
      if (!accessToken ) {
        console.error('Auth tokens not provided!')
        // You could redirect or show an error here
        // document.body.innerHTML = "<h1>Authentication Error</h1><p>Tokens not provided.</p>";
      }

      // --- 2. Monkey-Patch XMLHttpRequest (for older games) ---
      const originalXhrOpen = XMLHttpRequest.prototype.open
      XMLHttpRequest.prototype.open = function (method, url, async, user, password) {
        // Store the URL this request is for
        this._url = url
        return originalXhrOpen.apply(this, arguments)
      }

      const originalXhrSend = XMLHttpRequest.prototype.send
      XMLHttpRequest.prototype.send = function (body) {
        // Check if this request is going to our game server
        // We check for '/game/' which is our PHP API route
        if (this._url && this._url.toString().startsWith('/games/')) {
          // Set our auth headers
          this.setRequestHeader('Authorization', `Bearer ${accessToken}`)
          this.setRequestHeader('X-State-Refresh', refreshToken)
          this.setRequestHeader(
            'X-API-KEY',
            '6S7tVxlDEgmf19AcPuUt0cDh4vCq6hoXV3jhWoDGfq1byrur5cAfd1VUkWtMaDhq'
          )
        }
        return originalXhrSend.apply(this, arguments)
      }

      // --- 3. Monkey-Patch fetch (for modern games) ---
      const originalFetch = window.fetch
      window.fetch = function (url, options) {
        // Check if this request is going to our game server
        if (url && url.toString().startsWith('/game/')) {
          // Add our auth headers
          options = options || {}
          options.headers = options.headers || {}
          options.headers['Authorization'] = `Bearer ${accessToken}`
          options.headers['X-State-Refresh'] = refreshToken
          options.headers['X-API-KEY'] =
            '6S7tVxlDEgmf19AcPuUt0cDh4vCq6hoXV3jhWoDGfq1byrur5cAfd1VUkWtMaDhq'
        }
        return originalFetch.apply(this, [url, options])
      }
    })()
  </script>
  <script nonce="MTY5MjQ0NjI5LDI1MzM0NTY4ODE=">
    // localStorage.clear()
    const params = new URLSearchParams(window.location.search)
    if (params.get('userId') == null) params.set('userId', 195)
    // if (!sessionStorage.getItem('sessionId') || !sessionStorage.getItem('sessionId').includes('-')) {
    //       const user = JSON.parse(localStorage.get('sb-pykjixfuargqkjkgxsyc-auth-token'))
    // console.log(user)
    const userId = params.get('userId')
    sessionStorage.setItem('sessionId', `${userId}00${parseInt(Math.random() * 1000000)}`)
    // }

    var exitUrl = ''
    if (document.location.href.split('api_exit=')[1] != undefined) {
      exitUrl = document.location.href.split('api_exit=')[1].split('&')[0]
    }
    addEventListener('message', function (ev) {
      if (ev.data == 'CloseGame') {
        var isFramed = false
        try {
          isFramed =
            window != window.top || document != top.document || self.location != top.location
        } catch (e) {
          isFramed = true
        }

        if (isFramed) {
          window.parent.postMessage('CloseGame', '*')
        }
        document.location.href = exitUrl
      }
    })

    function ResizeHandler() {
      var frm = document.getElementById('game')

      frm.style['height'] = window.innerHeight + 'px'
    }

    addEventListener('resize', ResizeHandler)
    addEventListener('orientationchange', ResizeHandler)
  </script>

  <body
    onload="ResizeHandler();"
    style="margin: 0px; width: 100%; background-color: black; overflow: hidden"
  >
    <iframe
      id="game"
      style="margin: 0px; border: 0px; width: 100%; height: 100vh"
      src=/games/netent/NarcosNET/games/narcos-client/game/narcos-client.xhtml?launchType=iframe&iframeSandbox=allow-scripts%20allow-popups%20allow-popups-to-escape-sandbox%20allow-top-navigation%20allow-top-navigation-by-user-activation%20allow-same-origin%20allow-forms%20allow-pointer-lock&applicationType=browser&gameId=narcos_not_mobile&server=https%3A%2F%2Fnetent-game.casinomodule.com%2F&lang=en&sessId=DEMO-3262959954-EUR&operatorId=netent&statisticEndpointURL=/&casinourl=/&loadSeqNo=0&access_token=${accessToken}&refresh_token=${refreshToken}`
      allowfullscreen
    >
    </iframe>
  </body>
  <script
    rel="javascript"
    type="text/javascript"
    src="/games/netent/NarcosNET/device.js"
    nonce="MTY5MjQ0NjI5LDI1MzM0NTY4ODE="
  ></script>
  <!-- <script rel="javascript" type="text/javascript" src="/games/NarcosNET/addon.js" nonce="MTY5MjQ0NjI5LDI1MzM0NTY4ODE="></script> -->
</html>
